name: build-webkit-windows

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 720
    env:
      WEBKIT_DIR: D:\a\_temp\WebKit
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure git line endings
        shell: powershell
        run: |
          git config --global core.autocrlf input
          git config --global core.longpaths true

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install dependencies (WinGet)
        shell: powershell
        run: |
          $common = @(
            "--accept-package-agreements",
            "--accept-source-agreements",
            "--disable-interactivity",
            "--silent"
          )
          $machineScope = @("--scope=machine")
          $packages = @(
            "Git.Git",
            "Kitware.CMake",
            "Ninja-build.Ninja",
            "RubyInstallerTeam.Ruby.3.2",
            "ApacheFriends.Xampp.8.2",
            "LLVM.LLVM"
          )
          foreach ($pkg in $packages) {
            winget install @common @machineScope --id $pkg
          }
          winget install @common --id GnuWin32.Gperf

      - name: Resolve WebKit SHA (remote)
        id: webkit-sha
        shell: powershell
        run: |
          $sha = (git ls-remote https://github.com/WebKit/WebKit.git HEAD).Split("`t")[0].Trim()
          if (-not $sha) { throw "Failed to resolve WebKit HEAD SHA." }
          "sha=$sha" >> $env:GITHUB_OUTPUT

      - name: Cache WebKit source
        id: cache-webkit-src
        uses: actions/cache@v4
        with:
          path: ${{ env.WEBKIT_DIR }}
          key: webkit-src-${{ runner.os }}-${{ steps.webkit-sha.outputs.sha }}
          restore-keys: |
            webkit-src-${{ runner.os }}-

      - name: Clone WebKit
        if: steps.cache-webkit-src.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          git -c core.longpaths=true clone --depth 1 --single-branch https://github.com/WebKit/WebKit.git $env:WEBKIT_DIR

      - name: Verify WebKit checkout
        shell: powershell
        run: |
          $script = Join-Path $env:WEBKIT_DIR "Tools\Scripts\build-webkit"
          if (-not (Test-Path $script)) {
            throw "WebKit checkout missing build-webkit. Clone may be incomplete."
          }

      - name: Cache WebKit Windows libraries
        uses: actions/cache@v4
        with:
          path: ${{ env.WEBKIT_DIR }}/WebKitLibraries/win
          key: webkit-win-libs-${{ runner.os }}-${{ steps.webkit-sha.outputs.sha }}
          restore-keys: |
            webkit-win-libs-${{ runner.os }}-

      - name: Cache WebKit build output
        uses: actions/cache@v4
        with:
          path: ${{ env.WEBKIT_DIR }}/WebKitBuild
          key: webkit-build-${{ runner.os }}-${{ steps.webkit-sha.outputs.sha }}
          restore-keys: |
            webkit-build-${{ runner.os }}-

      - name: Install Python dependencies
        shell: powershell
        run: |
          python -m pip install --upgrade pip
          python -m pip install pywin32

      - name: Build WebKit (Release)
        shell: powershell
        run: |
          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          if (-not (Test-Path $vswhere)) { throw "vswhere.exe not found. Install Visual Studio with Desktop C++ workload." }
          $vsInstall = & $vswhere -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath
          if (-not $vsInstall) { throw "Visual Studio with C++ tools not found." }

          $vcvars = Join-Path $vsInstall "VC\Auxiliary\Build\vcvars64.bat"
          if (-not (Test-Path $vcvars)) { throw "vcvars64.bat not found at $vcvars" }

          $env:PATH = "C:\xampp\apache\bin;C:\xampp\perl\bin;C:\xampp\mysql\bin;C:\Program Files\CMake\bin;C:\Program Files\Ninja;C:\Program Files\Git\usr\bin;C:\Program Files\Git\bin;C:\Program Files\LLVM\bin;C:\Program Files (x86)\GnuWin32\bin;$env:PATH"
          $env:PYTHON = "python"
          $env:PYTHON3 = "python"
          $env:WEBKIT_LIBRARIES = Join-Path $env:WEBKIT_DIR "WebKitLibraries\win"
          $env:WEBKIT_OUTPUTDIR = Join-Path $env:WEBKIT_DIR "WebKitBuild"
          $env:WEBKIT_TESTFONTS = Join-Path $env:WEBKIT_DIR "Tools\WebKitTestRunner\fonts"
          $env:DUMPRENDERTREE_TEMP = $env:TEMP
          $env:CC = "clang-cl"
          $env:CXX = "clang-cl"
          $env:PATH = "$env:WEBKIT_LIBRARIES\bin;$env:PATH"

          cmd /c "call `"$vcvars`" && cd /d `"$env:WEBKIT_DIR`" && perl Tools\Scripts\build-webkit --release"

      - name: Package MiniBrowser zip
        shell: powershell
        run: |
          $out = Join-Path $env:GITHUB_WORKSPACE "dist"
          New-Item -ItemType Directory -Force -Path $out | Out-Null

          $bin = Join-Path $env:WEBKIT_DIR "WebKitBuild\Release\bin64"
          $libs = Join-Path $env:WEBKIT_DIR "WebKitLibraries\win\bin"

          $pkg = Join-Path $out "MiniBrowser"
          New-Item -ItemType Directory -Force -Path $pkg | Out-Null

          Copy-Item "$bin\MiniBrowser.exe" $pkg
          Copy-Item "$bin\*.dll" $pkg -ErrorAction SilentlyContinue
          if (Test-Path $libs) {
            Copy-Item "$libs\*.dll" $pkg -ErrorAction SilentlyContinue
          }

          $zipName = "webkit-windows-${env:GITHUB_REF_NAME}.zip"
          if (-not $env:GITHUB_REF_NAME) { $zipName = "webkit-windows-${env:GITHUB_SHA}.zip" }
          Compress-Archive -Path "$pkg\*" -DestinationPath (Join-Path $out $zipName) -Force

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: webkit-windows-zip
          path: dist/*.zip

      - name: Publish GitHub Release
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.zip
          generate_release_notes: true
